<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/pages/style/addsaldo.css" />
    <title>IF - Lanches</title>
  </head>

  <body>
    <header class="navbar">
      <div class="navbar-left">
        <img
          src="/img/Logoiflanches-removebg-preview.png"
          alt="Logo IF Lanches"
          class="logo"
        />
      </div>

      <nav class="navbar-center">
        <a href="/home">INÍCIO</a>
        <a href="/cardapio">CARDÁPIO</a>
        <a href="/gerenciar" class="link-gerenciar">GERENCIAR</a>
      </nav>

      <div class="navbar-right">
        <span class="saldo">R$ ${usuario.saldo}</span>
        <img
          src="/img/perfil-usuario.jpg"
          alt="Foto de Perfil"
          class="perfil"
          onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png';"
        />
      </div>

      <div class="menu-btn" id="menu-btn">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="/home">INÍCIO</a>
      <a href="#">CARDÁPIO</a>
      <a href="gerenciar.html">GERENCIAR</a>
    </div>

    <main>
      <center>
        <input
          type="text"
          class="usuario"
          name="usuario"
          placeholder="Procurar Usuario"
        />
      </center>

      <section class="perfil-card">
        <div class="perfil-foto">
          <img
            id="fotoUsuario"
            src="/img/perfil-usuario.jpg"
            alt="Foto do Usuário"
            onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png';"
          />
          <label for="inputFoto" class="alterar-foto">Alterar Foto</label>
          <input type="file" id="inputFoto" accept="image/*" hidden />
        </div>

        <div class="perfil-info">
          <h1>
            Seja bem-vindo,
            <span id="nomeUsuario">${usuario.nomePrimeiro}</span>!
          </h1>
          <div class="perfil-selo">Cliente</div>

          <div class="dados-usuario">
            <p>
              <strong>Nome Completo:</strong>
              <span id="nomeCompleto">${usuario.nome}</span>
            </p>
            <p>
              <strong>Responsavel:</strong>
              <span id="respUsuario">${usuario.responsavel}</span>
            </p>
            <p>
              <strong>CPF:</strong>
              <span id="cpfUsuario">${usuario.cpf}</span>
            </p>
            <p>
              <strong>Curso:</strong>
              <span id="curso">${usuario.curso}</span>
            </p>

            <br />
          </div>
        </div>

        <!-- Botão que abre o modal -->
        <button class="alterar-saldo" id="btnAbrirModal">
          ADICIONAR SALDO
        </button>
      </section>
    </main>

    <dialog id="modalAdd">
      <form class="form-produto">
        <button type="button" class="close-modal" onclick="modalAdd.close()">
          ✕
        </button>
        <br />
        <input type="number" placeholder="Quantidade (R$)" />

        <button type="submit" class="btn-add-prod">Adicionar Saldo</button>
      </form>
    </dialog>

    <script>

      const modalAdd = document.getElementById("modalAdd");
      const btnAbrirModal = document.getElementById("btnAbrirModal");

      btnAbrirModal.addEventListener("click", () => {
        modalAdd.showModal();
      });

      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");

      menuBtn.addEventListener("click", () => {
        menuBtn.classList.toggle("active");
        mobileMenu.classList.toggle("open");
      });

      let usuarioSelecionadoId = null;

      const campoBusca = document.querySelector(".usuario");

      campoBusca.addEventListener("input", async () => {
        const nome = campoBusca.value.trim();
        if (nome.length < 2) return;

        try {
          const resposta = await fetch(
            `/usuario/buscar?nome=${encodeURIComponent(nome)}`
          );

          if (!resposta.ok) {
            console.log("Usuário não encontrado");
            return;
          }

          const usuario = await resposta.json();

          usuarioSelecionadoId = usuario.id;

          document.getElementById("nomeUsuario").textContent =
            usuario.nome_usuario.split(" ")[0];
          document.getElementById("nomeCompleto").textContent =
            usuario.nome_usuario;
          document.getElementById("respUsuario").textContent =
            usuario.nome_responsavel;
          document.getElementById("curso").textContent = usuario.curso;
          document.getElementById("cpfUsuario").textContent = usuario.cpf;
        } catch (e) {
          console.log("Erro ao buscar usuário:", e);
        }
      });

      document
        .querySelector(".btn-add-prod")
        .addEventListener("click", async (e) => {
          e.preventDefault();

          const valor = document.querySelector("input[type=number]").value;

          const resposta = await fetch("/usuario/addsaldo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id_usuario: usuarioSelecionadoId,
              valor: valor,
            }),
          });
        });
    </script>
  </body>
</html>
