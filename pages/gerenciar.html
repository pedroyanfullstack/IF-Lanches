<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/pages/style/gerenciar.css" />
    <title>IF - Lanches</title>
  </head>
  <body>
    <header class="navbar">
      <div class="navbar-left">
        <img
          src="/img/Logoiflanches-removebg-preview.png"
          alt="Logo IF Lanches"
          class="logo"
        />
      </div>
      <nav class="navbar-center">
        <a href="/home">INÍCIO</a>
        <a href="/cardapio">CARDÁPIO</a>
        <a href="/gerenciar" class="link-gerenciar">GERENCIAR</a>
      </nav>
      <div class="navbar-right">
        <span class="saldo">R$ ${usuario.saldo}</span>
        <a href="/perfil"
          ><img
            src="/img/perfil-usuario.jpg"
            alt="Foto de Perfil"
            class="perfil"
            onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'"
        /></a>
      </div>
      <div class="menu-btn" id="menu-btn">
        <span></span><span></span><span></span>
      </div>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="/home">INÍCIO</a>
      <a href="/cardapio">CARDÁPIO</a>
      <a href="/gerenciar" class="link-gerenciar">GERENCIAR</a>
    </div>

    <main>
      <h1>CRIAR OU EDITAR PRODUTOS</h1>
      <div id="gerent">
        <a href="/addproduto"><button>CADASTRAR PRODUTO</button></a>
        <a href="/addsaldo"><button>ADICIONAR SALDO USUARIO</button></a>
        <a href="/home"><button>RELATORIO DE PEDIDOS</button></a>
      </div>

      <h2>Lista de produtos cadastrados:</h2>
      <h3>Salgados</h3>
      <section class="produtos-grid" id="produtosSalgados"></section>
      <h3>Bebidas</h3>
      <section class="produtos-grid" id="produtosBebidas"></section>
    </main>

    <dialog id="modalEditar">
      <form id="formEditar" class="form-produto">
        <button type="button" class="close-modal" onclick="modalEditar.close()">
          ✕
        </button>

        <h2>Editar Produto</h2>

        <input type="hidden" id="editId" />

        <label>Nome do Produto:</label>
        <input type="text" id="editNome" required />

        <label>Descrição:</label>
        <textarea id="editDescricao" rows="4"></textarea>

        <label>Preço (R$):</label>
        <input type="number" step="0.01" id="editPreco" required />

        <label>Quantidade:</label>
        <input type="number" id="editQtd" required />

        <label>Categoria:</label>
        <select id="editCategoria" required>
          <option value="Salgados">Salgados</option>
          <option value="Bebidas">Bebidas</option>
        </select>

        <br /><br />
        <button type="submit" class="btnSalvar">Salvar Alterações</button>
      </form>
    </dialog>

    <script>
      const produtosSalgados = document.getElementById("produtosSalgados");
      const produtosBebidas = document.getElementById("produtosBebidas");

      const modalEditar = document.getElementById("modalEditar");
      const formEditar = document.getElementById("formEditar");

      const editId = document.getElementById("editId");
      const editNome = document.getElementById("editNome");
      const editDescricao = document.getElementById("editDescricao");
      const editPreco = document.getElementById("editPreco");
      const editQtd = document.getElementById("editQtd");
      const editCategoria = document.getElementById("editCategoria");

      function criarCard(prod) {
        const card = document.createElement("div");
        card.classList.add("card");

        card.innerHTML = `
            <h3>${prod.nome}</h3>
            <p>${prod.descricao || ""}</p>
            <p>Preço: R$ ${Number(prod.preco).toFixed(2)}</p>
            <p>Qtd: ${prod.quantidade}</p>
            <br>
            <button class="btneditar">Editar</button>
            <br>
          `;

        card.querySelector(".btneditar").addEventListener("click", () => {

          editId.value = prod.id;
          editNome.value = prod.nome;
          editDescricao.value = prod.descricao;
          editPreco.value = prod.preco;
          editQtd.value = prod.quantidade;
          editCategoria.value = prod.categoria;

          modalEditar.showModal();
        });

        if (prod.categoria === "Salgados") produtosSalgados.appendChild(card);
        else produtosBebidas.appendChild(card);
      }


      fetch("/lista/produtos")
        .then((res) => res.json())
        .then((lista) => lista.forEach(criarCard))
        .catch((err) => console.log("Erro ao carregar produtos:", err));

      formEditar.addEventListener("submit", async (e) => {
        e.preventDefault();

        const dadosAtualizados = {
          id: editId.value,
          nome: editNome.value,
          descricao: editDescricao.value,
          preco: editPreco.value,
          quantidade: editQtd.value,
          categoria: editCategoria.value,
        };

        fetch("/editar/produto", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dadosAtualizados),
        })
          .then((res) => res.json())
          .then(() => {
            alert("Produto atualizado com sucesso!");
            modalEditar.close();
            location.reload();
          })
          .catch(() => {
            alert("Erro ao atualizar produto!");
          });
      });
    </script>
  </body>
</html>
